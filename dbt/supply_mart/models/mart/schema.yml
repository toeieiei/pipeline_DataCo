version: 2

# ====================================================================
# 1. SOURCE DEFINITION (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö)
# ====================================================================

sources:
  - name: supply_chain_source
    # üö® FIX 1: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Schema ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏à‡πâ‡∏á
    schema: core_core 
    tables:
      # üö® FIX 2: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠ Table ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏à‡πâ‡∏á
      - name: supply_chain
        description: This is the raw supply chain dataset loaded into the core_core schema.


# ====================================================================
# 2. MODEL DEFINITIONS (Star Schema Tables)
# ====================================================================

models:
  
  # --- DIMENSION TABLES ---
  
  - name: dim_customer
    description: "Dimension table containing unique customer attributes (‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)."
    columns:
      - name: customer_key
        description: "Primary Key (Surrogate Key) for the customer dimension."
        tests:
          - not_null
          - unique
      - name: customer_id
        description: "Original Customer ID from the source system (Business Key)."
        tests:
          - not_null
          # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏™ unique ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ GROUP BY ‡πÉ‡∏ô dim ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å
          - unique 

  - name: dim_product
    description: "Dimension table containing unique product and category information (‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)."
    columns:
      - name: product_key
        description: "Primary Key (Surrogate Key) for the product dimension."
        tests:
          - not_null
          - unique
      - name: product_card_id
        description: "Original Product Card ID from the source system (Business Key)."
        tests:
          - not_null
      - name: product_price
        tests:
          - not_null

  - name: dim_location
    description: "Dimension table containing geographical information for orders (‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà)."
    columns:
      - name: location_key
        description: "Primary Key (Surrogate Key) for the location dimension."
        tests:
          - not_null
          - unique

  - name: dim_shipping
    description: "Dimension table containing shipping method and delivery status information (‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á)."
    columns:
      - name: shipping_key
        description: "Primary Key (Surrogate Key) for the shipping dimension."
        tests:
          - not_null
          - unique
      - name: shipping_mode
        tests:
          - not_null

  - name: dim_date
    description: "Dimension table containing calendar details for order and shipping dates (‡∏°‡∏¥‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)."
    columns:
      - name: date_key
        description: "Primary Key (Surrogate Key) for the date dimension."
        tests:
          - not_null
          - unique
      - name: full_date
        tests:
          - not_null
          - unique

  # --- FACT TABLE ---
  
  # üö® FIX 3: ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠ 'fct_order_items' ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå 'fact_order_item.sql'
  - name: fact_order_item
    description: "Core fact table containing order item measures and foreign keys to all dimensions (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)."
    columns:
      
      # üö® FIX 4: ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏ó‡∏™ Primary Key ‡∏°‡∏≤‡∏ó‡∏µ‡πà order_item_id 
      #         (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ 'order_item_key' ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô SQL)
      - name: order_item_id
        description: "Primary Key (Original Order Item ID), unique after deduplication."
        tests:
          - not_null
          - unique # ‚¨ÖÔ∏è ‡πÄ‡∏ó‡∏™‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å

      # FOREIGN KEY TESTS (Relationships)
      - name: customer_key
        description: "FK to dim_customer."
        tests:
          - not_null
          - relationships:
              to: ref('dim_customer')
              field: customer_key
              
      - name: product_key
        description: "FK to dim_product."
        tests:
          - not_null
          - relationships:
              to: ref('dim_product')
              field: product_key
              
      - name: order_date_key
        description: "FK to dim_date (Order Date)."
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_key
      
      - name: shipping_date_key
        description: "FK to dim_date (Shipping Date)."
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_key
              
      - name: location_key
        description: "FK to dim_location."
        tests:
          - not_null
          - relationships:
              to: ref('dim_location')
              field: location_key

      - name: shipping_key
        description: "FK to dim_shipping."
        tests:
          - not_null
          - relationships:
              to: ref('dim_shipping')
              field: shipping_key
              
      # MEASURE TESTS
      - name: sales
        tests:
          - not_null
      - name: order_item_total
        tests:
          - not_null